mkdir -p ../tmp/5ttgen/hsvs && 5ttgen hsvs freesurfer/sub-01 ../tmp/5ttgen/hsvs/aseg.mif -hippocampi aseg -thalami aseg -force && testing_diff_header ../tmp/5ttgen/hsvs/aseg.mif 5ttgen/hsvs/aseg.mif.gz
mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval tmp-sub-01_dwi.mif -export_grad_mrtrix tmp-sub-01_dwi.b -strides 0,0,0,1
mkdir -p ../tmp/dwi2mask && dwi2mask consensus tmp-sub-01_dwi.mif ../tmp/dwi2mask/consensus.mif
dwi2mask legacy tmp-sub-01_dwi.mif ../tmp/dwi2mask/legacy.mif -force && testing_diff_image ../tmp/dwi2mask/legacy.mif dwi2mask/legacy.mif.gz
dwi2mask mean tmp-sub-01_dwi.mif ../tmp/dwi2mask/mean.mif -force && testing_diff_image ../tmp/dwi2mask/mean.mif dwi2mask/mean.mif.gz
dwi2mask mtnorm tmp-sub-01_dwi.mif ../tmp/dwi2mask/mtnorm_default_mask.mif -tissuesum ../tmp/dwi2mask/mtnorm_default_tissuesum.mif -force && testing_diff_image ../tmp/dwi2mask/mtnorm_default_mask.mif dwi2mask/mtnorm_default_mask.mif.gz && testing_diff_image ../tmp/dwi2mask/mtnorm_default_tissuesum.mif dwi2mask/mtnorm_default_tissuesum.mif.gz -abs 1e-5
dwi2mask trace tmp-sub-01_dwi.mif ../tmp/dwi2mask/trace_default.mif -force && testing_diff_image ../tmp/dwi2mask/trace_default.mif dwi2mask/trace_default.mif.gz
dwi2mask trace tmp-sub-01_dwi.mif ../tmp/dwi2mask/trace_iterative.mif -iterative -force && testing_diff_image ../tmp/dwi2mask/trace_iterative.mif dwi2mask/trace_iterative.mif.gz
mkdir -p ../tmp/dwi2response/dhollander && dwi2response dhollander tmp-sub-01_dwi.mif ../tmp/dwi2response/dhollander/default_wm.txt ../tmp/dwi2response/dhollander/default_gm.txt ../tmp/dwi2response/dhollander/default_csf.txt -voxels ../tmp/dwi2response/dhollander/default.mif -force && testing_diff_matrix ../tmp/dwi2response/dhollander/default_wm.txt dwi2response/dhollander/default_wm.txt -abs 1e-2 && testing_diff_matrix ../tmp/dwi2response/dhollander/default_gm.txt dwi2response/dhollander/default_gm.txt -abs 1e-2 && testing_diff_matrix ../tmp/dwi2response/dhollander/default_csf.txt dwi2response/dhollander/default_csf.txt -abs 1e-2 && testing_diff_image ../tmp/dwi2response/dhollander/default.mif dwi2response/dhollander/default.mif.gz
mkdir -p ../tmp/dwi2response/fa && dwi2response fa tmp-sub-01_dwi.mif ../tmp/dwi2response/fa/default.txt -voxels ../tmp/dwi2response/fa/default.mif -number 20 -force && testing_diff_matrix ../tmp/dwi2response/fa/default.txt dwi2response/fa/default.txt -abs 1e-2 && testing_diff_image ../tmp/dwi2response/fa/default.mif dwi2response/fa/default.mif.gz
mkdir -p ../tmp/dwi2response/manual && dwi2response manual tmp-sub-01_dwi.mif dwi2response/fa/default.mif.gz ../tmp/dwi2response/manual/default.txt -force && testing_diff_matrix ../tmp/dwi2response/manual/default.txt dwi2response/manual/default.txt -abs 1e-2
mkdir -p ../tmp/dwi2response/msmt_5tt && dwi2response msmt_5tt tmp-sub-01_dwi.mif BIDS/sub-01/anat/sub-01_5TT.nii.gz ../tmp/dwi2response/msmt_5tt/default_wm.txt ../tmp/dwi2response/msmt_5tt/default_gm.txt ../tmp/dwi2response/msmt_5tt/default_csf.txt -voxels ../tmp/dwi2response/msmt_5tt/default.mif -pvf 0.9 -force && testing_diff_matrix ../tmp/dwi2response/msmt_5tt/default_wm.txt dwi2response/msmt_5tt/default_wm.txt -abs 1e-2 && testing_diff_matrix ../tmp/dwi2response/msmt_5tt/default_gm.txt dwi2response/msmt_5tt/default_gm.txt -abs 1e-2 && testing_diff_matrix ../tmp/dwi2response/msmt_5tt/default_csf.txt dwi2response/msmt_5tt/default_csf.txt -abs 1e-2 && testing_diff_image ../tmp/dwi2response/msmt_5tt/default.mif dwi2response/msmt_5tt/default.mif.gz
mkdir -p ../tmp/dwi2response/tax && dwi2response tax tmp-sub-01_dwi.mif ../tmp/dwi2response/tax/default.txt -voxels ../tmp/dwi2response/tax/default.mif -force && testing_diff_matrix ../tmp/dwi2response/tax/default.txt dwi2response/tax/default.txt -abs 1e-2 && testing_diff_image ../tmp/dwi2response/tax/default.mif dwi2response/tax/default.mif.gz
mkdir -p ../tmp/dwi2response/tournier && dwi2response tournier tmp-sub-01_dwi.mif ../tmp/dwi2response/tournier/default.txt -voxels ../tmp/dwi2response/tournier/default.mif -number 20 -iter_voxels 200 -force && testing_diff_matrix ../tmp/dwi2response/tournier/default.txt dwi2response/tournier/default.txt -abs 1e-2 && testing_diff_image ../tmp/dwi2response/tournier/default.mif dwi2response/tournier/default.mif.gz
mkdir -p ../tmp/dwibiascorrect/mtnorm && dwibiascorrect mtnorm tmp-sub-01_dwi.mif ../tmp/dwibiascorrect/mtnorm/default_out.mif -bias ../tmp/dwibiascorrect/mtnorm/default_bias.mif -force && testing_diff_image ../tmp/dwibiascorrect/mtnorm/default_out.mif dwibiascorrect/mtnorm/default_out.mif.gz -frac 1e-5 && testing_diff_image ../tmp/dwibiascorrect/mtnorm/default_bias.mif dwibiascorrect/mtnorm/default_bias.mif.gz -frac 1e-5
mkdir -p ../tmp/dwibiasnormmask && dwibiasnormmask tmp-sub-01_dwi.mif ../tmp/dwibiasnormmask/default_out.mif ../tmp/dwibiasnormmask/default_mask.mif -output_bias ../tmp/dwibiasnormmask/default_bias.mif -output_scale ../tmp/dwibiasnormmask/default_scale.txt -output_tissuesum ../tmp/dwibiasnormmask/default_tissuesum.mif -force && testing_diff_image ../tmp/dwibiasnormmask/default_out.mif dwibiasnormmask/default_out.mif.gz -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/default_mask.mif dwibiasnormmask/default_mask.mif.gz && testing_diff_image ../tmp/dwibiasnormmask/default_bias.mif dwibiasnormmask/default_bias.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwibiasnormmask/default_scale.txt dwibiasnormmask/default_scale.txt -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/default_tissuesum.mif dwibiasnormmask/default_tissuesum.mif.gz -abs 1e-5
mkdir -p ../tmp/dwicat && mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval tmp.mif -force && dwiextract tmp.mif tmp01_b1000.mif -shells 0,1000 -force && dwiextract tmp.mif tmp01_b2000.mif -shells 0,2000 -force && dwiextract tmp.mif tmp01_b3000.mif -shells 0,3000 -force && mrcat tmp01_b1000.mif tmp01_b2000.mif tmp01_b3000.mif -axis 3 tmp02.mif -force && mrcalc tmp01_b2000.mif 0.2 -mult tmp03_b2000.mif -force && mrcalc tmp01_b3000.mif 5.0 -mult tmp03_b3000.mif && mrcat tmp01_b1000.mif tmp03_b2000.mif tmp03_b3000.mif -axis 3 tmp03.mif -force && dwicat tmp01_b1000.mif tmp03_b2000.mif tmp03_b3000.mif ../tmp/dwicat/sharedb0_masked.mif -mask BIDS/sub-01/dwi/sub-01_brainmask.nii.gz -force && testing_diff_image ../tmp/dwicat/sharedb0_masked.mif tmp02.mif -frac 1e-6
mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval tmp-sub-01_dwi.mif -export_grad_mrtrix tmp-sub-01_dwi.b -strides 0,0,0,1 -force && dwigradcheck tmp-sub-01_dwi.mif -number 1000
mkdir -p ../tmp/dwinormalise/group && mkdir -p tmp-dwi && mkdir -p tmp-mask && mrconvert BIDS/sub-02/dwi/sub-02_dwi.nii.gz -fslgrad BIDS/sub-02/dwi/sub-02_dwi.bvec BIDS/sub-02/dwi/sub-02_dwi.bval tmp-dwi/sub-02.mif -force && mrconvert BIDS/sub-02/dwi/sub-02_brainmask.nii.gz tmp-mask/sub-02.mif -force && mrconvert BIDS/sub-03/dwi/sub-03_dwi.nii.gz -fslgrad BIDS/sub-03/dwi/sub-03_dwi.bvec BIDS/sub-03/dwi/sub-03_dwi.bval tmp-dwi/sub-03.mif -force && mrconvert BIDS/sub-03/dwi/sub-03_brainmask.nii.gz tmp-mask/sub-03.mif -force && dwinormalise group tmp-dwi/ tmp-mask/ ../tmp/dwinormalise/group/ ../tmp/dwinormalise/group/fa.mif ../tmp/dwinormalise/group/mask.mif -force && testing_diff_image ../tmp/dwinormalise/group/sub-02.mif dwinormalise/group/sub-02.mif.gz -frac 1e-2 && testing_diff_image ../tmp/dwinormalise/group/sub-03.mif dwinormalise/group/sub-03.mif.gz -frac 1e-2 && testing_diff_image ../tmp/dwinormalise/group/fa.mif dwinormalise/group/fa.mif.gz -abs 1e-3 && testing_diff_image $(mrfilter ../tmp/dwinormalise/group/mask.mif smooth -) $(mrfilter dwinormalise/group/mask.mif.gz smooth -) -abs 0.3
mkdir ../tmp/dwinormalise/individual && dwinormalise individual BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval BIDS/sub-01/dwi/sub-01_brainmask.nii.gz ../tmp/dwinormalise/individual/out.mif -force && testing_diff_image ../tmp/dwinormalise/individual/out.mif dwinormalise/individual/out.mif.gz -frac 1e-5
mkdir ../tmp/dwinormalise/mtnorm && dwinormalise mtnorm tmp-sub-01_dwi.mif ../tmp/dwinormalise/mtnorm/default_out.mif -scale ../tmp/dwinormalise/mtnorm/default_scale.txt -force && testing_diff_image ../tmp/dwinormalise/mtnorm/default_out.mif dwinormalise/mtnorm/default_out.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwinormalise/mtnorm/default_scale.txt dwinormalise/mtnorm/default_scale.txt -abs 1e-5
mkdir -p ../tmp/dwishellmath && mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval tmp1.mif -export_grad_mrtrix tmp1.b -force && dwiextract tmp1.mif tmp1_b0.mif -shell 0 -force && dwiextract tmp1.mif tmp1_b1000.mif -shell 1000 -force && dwiextract tmp1.mif tmp1_b2000.mif -shell 2000 -force && dwiextract tmp1.mif tmp1_b3000.mif -shell 3000 -force && mrmath tmp1_b0.mif mean tmp2_b0.mif -axis 3 -force && mrmath tmp1_b1000.mif mean tmp2_b1000.mif -axis 3 -force && mrmath tmp1_b2000.mif mean tmp2_b2000.mif -axis 3 -force && mrmath tmp1_b3000.mif mean tmp2_b3000.mif -axis 3 -force && mrcat tmp2_b0.mif tmp2_b1000.mif tmp2_b2000.mif tmp2_b3000.mif -axis 3 tmp2.mif -force && dwishellmath tmp1.mif mean ../tmp/dwishellmath/default.mif -force && testing_diff_image ../tmp/dwishellmath/default.mif tmp2.mif
for_each -test 1 2 3 4 : echo IN
mkdir -p ../tmp/for_each && rm -f ../tmp/for_each/out.txt && for_each 1 2 3 4 : echo IN ">>" ../tmp/for_each/out.txt && testing_diff_matrix ../tmp/for_each/out.txt foreach/out.txt
for_each -nthreads 2 1 2 3 4 : mrconvert BIDS/sub-01/dwi/sub-01_brainmask.nii.gz tmpIN.mif -force
mkdir -p ../tmp/population_template && mkdir -p tmp-mask && mkdir -p tmp-fa && mkdir -p tmp-fod && mrconvert BIDS/sub-02/dwi/sub-02_brainmask.nii.gz tmp-mask/sub-02.mif -force && mrconvert BIDS/sub-03/dwi/sub-03_brainmask.nii.gz tmp-mask/sub-03.mif -force && dwi2tensor BIDS/sub-02/dwi/sub-02_dwi.nii.gz -fslgrad BIDS/sub-02/dwi/sub-02_dwi.bvec BIDS/sub-02/dwi/sub-02_dwi.bval -mask BIDS/sub-02/dwi/sub-02_brainmask.nii.gz - | tensor2metric - -fa tmp-fa/sub-02.mif -force && dwi2tensor BIDS/sub-03/dwi/sub-03_dwi.nii.gz -fslgrad BIDS/sub-03/dwi/sub-03_dwi.bvec BIDS/sub-03/dwi/sub-03_dwi.bval -mask BIDS/sub-03/dwi/sub-03_brainmask.nii.gz - | tensor2metric - -fa tmp-fa/sub-03.mif -force && population_template tmp-fa ../tmp/population_template/fa_default_template.mif -warp_dir ../tmp/population_template/fa_default_warpdir/ -transformed_dir ../tmp/population_template/fa_default_transformeddir/ -linear_transformations_dir ../tmp/population_template/fa_default_lineartransformsdir/ -force && testing_diff_image ../tmp/population_template/fa_default_template.mif population_template/fa_default_template.mif.gz -abs 0.01
mkdir -p tmp-fod && tail -n1 BIDS/sub-02/dwi/sub-02_tissue-WM_response.txt > tmp.txt && dwi2fod csd BIDS/sub-02/dwi/sub-02_dwi.nii.gz tmp.txt -fslgrad BIDS/sub-02/dwi/sub-02_dwi.bvec BIDS/sub-02/dwi/sub-02_dwi.bval -mask BIDS/sub-02/dwi/sub-02_brainmask.nii.gz tmp-fod/sub-02.mif -lmax 4 -force && tail -n1 BIDS/sub-03/dwi/sub-03_tissue-WM_response.txt > tmp.txt && dwi2fod csd BIDS/sub-03/dwi/sub-03_dwi.nii.gz tmp.txt -fslgrad BIDS/sub-03/dwi/sub-03_dwi.bvec BIDS/sub-03/dwi/sub-03_dwi.bval -mask BIDS/sub-03/dwi/sub-03_brainmask.nii.gz tmp-fod/sub-03.mif -lmax 4 -force && population_template tmp-fod/ ../tmp/population_template/fod_default_template.mif -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fod_default_mask.mif -force && testing_diff_image ../tmp/population_template/fod_default_template.mif population_template/fod_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fod_default_mask.mif smooth -) $(mrfilter population_template/fod_mask.mif.gz smooth -) -abs 0.3
mkdir -p ../tmp/responsemean && responsemean BIDS/sub-02/dwi/sub-02_tissue-WM_response.txt BIDS/sub-03/dwi/sub-03_tissue-WM_response.txt ../tmp/responsemean/out.txt -force && testing_diff_matrix ../tmp/responsemean/out.txt responsemean/out.txt -abs 0.001
responsemean BIDS/sub-02/dwi/sub-02_tissue-WM_response.txt BIDS/sub-03/dwi/sub-03_tissue-WM_response.txt ../tmp/responsemean/legacy.txt -legacy -force && testing_diff_matrix ../tmp/responsemean/legacy.txt responsemean/legacy.txt -abs 0.001
